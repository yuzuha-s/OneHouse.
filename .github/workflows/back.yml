name: Run Onehouse

on:
  push:
    branches:
      - feature/workflow
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      DB_CONNECTION: mysql
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: onehouse
      DB_USERNAME: root
      DB_PASSWORD: password

      BROADCAST_DRIVER: log
      CACHE_DRIVER: array
      QUEUE_CONNECTION: array
      SESSION_DRIVER: array

    defaults:
      run:
        working-directory: onehouse

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          tools: phpstan, phpcs
          extensions: mbstring, bcmath, pdo_mysql, swoole

      - name: Install MySQL
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mysql-server
          sudo service mysql start
          mysql -uroot -ppassword -e "CREATE DATABASE onehouse;"
          mysql -uroot -ppassword -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'password'; FLUSH PRIVILEGES;"

      - name: Create .env
        run: |
          cp .env.example .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=onehouse/' .env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=root/' .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=password/' .env
          sed -i "s|APP_KEY=|APP_KEY=${{ secrets.APP_KEY }}|" .env

      - name: Install dependencies
        run: composer install --no-scripts

      - name: Diagnose before migrations
        run: |
          echo "=== onehouse/.env ==="
          if [ -f .env ]; then cat .env; else echo ".env not found"; fi
          echo ""
          echo "=== Process env DB_* ==="
          env | grep '^DB_' || true
          echo ""
          echo "=== getent hosts mysql ==="
          getent hosts mysql || echo "no mysql host entry"
          echo ""
          echo "=== /etc/hosts ==="
          cat /etc/hosts || true
          echo ""
          echo "=== ping mysql ==="
          ping -c1 mysql || echo "ping failed"
          echo ""
          echo "=== mysql query check ==="
          mysql -h 127.0.0.1 -uroot -ppassword -e "SELECT 1;" && echo "mysql ok" || echo "mysql query failed"

      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h 127.0.0.1 -uroot -ppassword --silent && break
            echo "Waiting for MySQL..."
            sleep 2
          done

      - name: Diagnose MySQL
        run: |
          mysql -h 127.0.0.1 -uroot -ppassword -e "SELECT 1;" && echo "mysql ok" || echo "mysql query failed"

      - name: Run migrations
        run: php artisan migrate --force

      - name: Run tests
        run: php artisan test
